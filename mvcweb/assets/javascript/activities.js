function getYelpStarsImage(t){var e=img_path+"yelp/regular_";console.log(e);var i=t-Math.floor(t);return e+(t-i)+(0!==i?"_half":"")+".png"}function yelp(t,e){var i={display:!0,businesses:[]},a=$("#off-site-container");console.log("yelp called"),console.log(t),yapi&&yapi.abort(),yapi=api(server_prefix+"/api/yelp/","GET",{lat:resort.latitude,long:resort.longitude,cat_id:t.filters.map(function(t){return t.replace("cat_","")}).join(", "),radius:1e4},function(t){data=JSON.parse(t),data.businesses&&(data.businesses.sort(function(t,e){return e.rating-t.rating}),data.businesses.filter(function(t){return 4<=t.rating}).forEach(function(t){i.businesses.push({id:t.id,name:t.name,imageUrl:t.image_url,url:t.url,reviewCount:t.review_count,rating:t.rating,price:t.price,phone:t.phone,categories:t.categories.map(function(t){return t.title}).join(", ")})}),i.businesses.forEach(function(t){var e=getYelpStarsImage(t.rating),i=$("#off-site-card").clone().css("display","flex");i.attr("id",null),i.find("a").attr("href",t.url),t.imageUrl||(t.imageUrl="/yelp/Yelp-nophoto-Small.png"),i.find(".card-img-top").css({"background-image":'url("'+(t.imageUrl||yelpNotFoundImageSrc)+'")'}),i.find(".card-title").html(t.name),i.find(".activities-list-item-yelp-rating").attr("src",e),i.find(".yelp-rating-counter").html(t.reviewCount),i.find(".price").html(t.price);var s=t.categories;14<s.length&&(s=s.substr(0,14)+"..."),i.find(".tags").html(s),i.find(".yelp-tel").attr("href","tel:"+t.phone),a.append(i)}),e&&e())})}function onsiteWithOptions(c){if(console.log("onsite ON"),$("#on-site-filters").css({display:"block"}),$("#off-site-filters").css({display:"none"}),$("#off-site-container").css({display:"none"}),$("#on-site-container").css({display:"flex"}),$(".activities-content-block").removeClass("off-site"),$(".activities-content-block").addClass("on-site"),container=$(".on-site-card-deck"),window.location.hash&&1<window.location.hash.length){var t=window.location.hash.slice(1);return 1==container.find('[data-occurence-id="'+t+'"]').length?container.children().not('[data-occurence-id="'+t+'"]').css({display:"none"}):0<container.find('[data-activity-id="'+t.split("_")[0]+'"]').length&&container.children().not('[data-activity-id="'+t.split("_")[0]+'"]').css({display:"none"}),void(window.location.hash="")}var d,h=[];console.log(c),c.date?(console.log("DATE"),d=new Date(Date.parse(c.date+" UTC"))):(d=new Date).setUTCHours(0,0,0,0);var u=new Date(d);u.setDate(u.getDate()+60),container.children().each(function(t){var e=!1,s=!1,i=!0,a=$(this),n=a.attr("data-frequency"),o=new Date(Date.parse(a.attr("data-start")));if(new Date(Date.parse(a.attr("data-end"))),d<=o&&o<=u?e=!0:console.log(o+" "+d),c.date&&(attr=a.attr("data-day"),"undefined"!=typeof attr&&!1!==attr&&d.getDay()!=parseInt(a.attr("data-day"))&&(e=!1)),0<c.filters.length){s=!0;var r=c.filters;c.filters.forEach(function(t){var i,e=a.attr("data-tags").split(" ");$.each(e,function(t,e){if(0<=(i=r.indexOf(e)))return!(i=1)}),i<0&&(s=!1,console.log("did not find "+r+" in "+a.attr("data-tags")))})}else s=!0;if("daily"==n&&e&&s&&i){var l=a.attr("data-activity-id");h.includes(l)?i=!1:h.push(l)}e&&s&&i?a.css({display:"block"}):(a.css({display:"none"}),console.log("dr:"+e+" if:"+s+" idf:"+i))})}function offsiteWithOptions(t,e){$("#off-site-filters").css({display:"block"}),$("#on-site-filters").css({display:"none"}),$("#off-site-container").css({display:"flex"}),$(".activities-content-block").removeClass("on-site"),$(".activities-content-block").addClass("off-site"),yelp(t,e)}function getFiltersArray(t){var e,i=[];return e="onSite"==$(t).attr("data-type")?$("#on-site-filters"):$("#off-site-filters"),filterOptions=e.find(".js-filter").each(function(){var t=$(this);t.is(":checked")&&i.push(t.attr("name"))}),""==i&&e.find(".js-filter").each(function(){i.push($(this).attr("name"))}),i}function ActivityFavorites(){var i,t;function s(){0<i.length?Cookies.set("fav-activities",i,{expires:365}):Cookies.remove("fav-activities")}return this.add=function(t){i.includes(t)||(i.push(t),s())},this.remove=function(t){var e=i.indexOf(t);0<=e&&(i.splice(e,1),s())},this.isInFavorites=function(t){return i.includes(t)},this.getList=function(){return i},t=Cookies.getJSON("fav-activities"),i=void 0!==t?t:[],this}var activityFavorites=ActivityFavorites();function ActivityModule(e){var s,t={date:null,sort:null,filters:[]},n=new CustomEvent("changeSearchParams"),a=new CustomEvent("changeLayout");this.init=function(){var t=this;this.node=e,this.request=null,this.horizontalCalendar=new HorizontalCalendar(document.querySelector(".js-horizontal-calendar")),this.getNodes(),this.setDefaultOptions(),this.addEventListeners(),this.setGridGradientHeight(),this.initDatePicker(),this.initReadMoreBtns(),this.ellipsizeTextBox(),s=function(){t.closeAllDropDowns()},this.markFavorites()},this.getNodes=function(){this.els={layoutOptionsBtns:this.node.querySelectorAll(".js-layout-option"),activitiesGrid:this.node.querySelector(".js-activities-grid"),activitiesGridGradient:this.node.querySelector(".js-gradient"),datePickerNode:this.node.querySelector("#activityDate"),activityModeToggler:this.node.querySelectorAll(".js-activity-toggle-mode"),activityModeDeck:this.node.querySelectorAll(".js-card-deck"),filters:this.node.querySelectorAll(".js-filter"),sorting:this.node.querySelector(".js-sorting"),sortingOptionsMobile:this.node.querySelectorAll(".js-sort-by-option"),datePickerTriggers:this.node.querySelectorAll(".js-datepicker-trigger"),slideDownTogglers:this.node.querySelectorAll(".js-slide-down"),mobileFiltersOverlay:this.node.querySelector(".js-filters-overlay"),mobileFiltersBtn:this.node.querySelector(".js-mobile-filters"),mobileClosedFiltersBtn:this.node.querySelector(".btn-closed-filters"),filtersWrapper:this.node.querySelector(".js-activities-filters-wrapper")}},this.setDefaultOptions=function(){this.options=$.extend({},t)},this.switchLayout=function(t){var e=t.currentTarget.getAttribute("data-type");[].forEach.call(this.els.layoutOptionsBtns,function(t){t.getAttribute("data-type")===e?t.classList.add("active"):t.classList.remove("active")}),this.els.activitiesGrid.classList.remove("layout-list"),this.els.activitiesGrid.classList.remove("layout-table"),this.els.activitiesGrid.classList.add("layout-"+e),this.node.dispatchEvent(a)},this.switchMode=function(t){var e=t.currentTarget.getAttribute("data-type");[].forEach.call(this.els.activityModeToggler,function(t){t.getAttribute("data-type")===e?t.classList.add("active"):t.classList.remove("active")}),[].forEach.call(this.els.activityModeDeck,function(t){t.getAttribute("data-type")===e?t.classList.add("active"):t.classList.remove("active")}),this.getData(),this.node.dispatchEvent(a)},this.switchFilterState=function(t){var e;t.target?e=t.target:(e=t).checked=!e.checked,e.checked?this.options.filters.push(e.name):this.options.filters.splice(this.options.filters.indexOf(e.name),1),this.node.dispatchEvent(n)},this.switchSorting=function(t){var e=(t=t.currentTarget).value||t.getAttribute("data-value");"BUTTON"===t.nodeName&&(this.els.sorting.value=e),[].forEach.call(this.els.sortingOptionsMobile,function(t){t.getAttribute("data-value")===e?t.classList.add("active"):t.classList.remove("active")}),this.options.sort=e,this.node.dispatchEvent(n);var i=$("#on-site-container .card");if(i.css("order",i.length+1),"favourites"==e)activityFavorites.getList().forEach(function(t,e){$('#on-site-container .card[data-occurence-id="'+t+'"]').css("order",e)});else{var s={};i.each(function(t){var e=$(this),i=e.attr("data-start")+" "+e.attr("data-start-time");s[i]=e.attr("data-occurence-id")});var a=Object.keys(s).sort();"desc"==e&&a.reverse(),a.forEach(function(t,e){$('#on-site-container .card[data-occurence-id="'+s[t]+'"]').css("order",e)})}},this.toggleTextCollapse=function(t){t.preventDefault(),t.stopPropagation();var e=t.target,i=e.parentNode,s=e.previousElementSibling;i.classList.toggle("collapsed"),s.innerHTML=s.getAttribute("data-text"),this.ellipsizeTextBox(t,i)},this.getActiveDeck=function(){return document.querySelector(".js-card-deck.active")},this.addLoader=function(t){if(!t.querySelector(".loader")){var e=document.createElement("div");e.classList.add("loader");var i=document.createElement("div");i.classList.add("spinner"),e.appendChild(i),t.appendChild(e)}},this.removeLoader=function(t){var e=t.querySelector(".loader");e&&t.removeChild(e)},this.getData=function(){var t=this,e=this.getActiveDeck();null!=this.request&&(this.request.abort(),this.request=null),this.options.filters=getFiltersArray(e),console.log(this.options.filters),"on-site-container"==$(e).attr("id")?onsiteWithOptions(this.options):($("#off-site-container").empty(),t.addLoader(e),offsiteWithOptions(this.options,function(){t.removeLoader(e)}))},this.setNewDate=function(t){this.options.date=t,this.node.dispatchEvent(n)},this.initDatePicker=function(){var t=this,e={dayNamesMin:["S","M","T","W","T","F","S"],minDate:0,defaultDate:0,beforeShow:function(t,e){setTimeout(function(){e.dpDiv.css({top:$("#activityDate").offset().top+35,left:$("#activityDate").offset().left})},0)}};$(this.els.datePickerNode).datepicker(e),$(this.els.datePickerNode).on("change",function(){t.setNewDate($(this).val())})},this.initReadMoreBtns=function(){$(".js-read-more-container").readmore({moreLink:'<button type="button" class="marriott-btn position-absolute">READ MORE</button>',lessLink:'<button type="button" class="marriott-btn position-absolute">CLOSE</button>',beforeToggle:function(t,e,i){e.attr("aria-expanded",!i)}})},this.markFavorites=function(){var t=document.getElementsByClassName("js-add-to-favorites");for(i=0;i<t.length;i++){var e=t[i].closest(".card");activityFavorites.isInFavorites(e.getAttribute("data-occurence-id"))?(t[i].classList.add("active"),e.setAttribute("data-fav",1)):(t[i].classList.remove("active"),e.setAttribute("data-fav",0))}},this.ellipsizeTextBox=function(t,e){var i;e?(i=[]).push(e):i=document.querySelectorAll(".js-read-more-block"),[].forEach.call(i,function(t){var e=t.querySelector(".js-text-ellipsis");if(t.classList.contains("ellipsized")&&(e.innerText=e.getAttribute("data-text")),t.scrollHeight>t.offsetHeight){t.classList.add("ellipsized"),e.setAttribute("data-text",e.innerText);for(var i=e.innerText.split("");t.scrollHeight>t.offsetHeight;)i.pop(),e.innerText=i.join("")+"..."}else t.classList.remove("ellipsized")})},this.triggerDatepicker=function(t){this.els.datePickerNode.focus()},this.openDropDown=function(t){t.classList.remove("d-none"),t.classList.add("d-flex"),document.addEventListener("click",s),setTimeout(function(){t.classList.add("animated")},1);var e=document.querySelector('[data-target="'+t.id+'"]');e.classList.add("active"),e.classList.add("expanded")},this.closeDropDown=function(t){t.classList.remove("animated"),document.removeEventListener("click",s),setTimeout(function(){t.classList.remove("d-flex"),t.classList.add("d-none")},200);var e=document.querySelector('[data-target="'+t.id+'"]');e.classList.remove("active"),e.classList.remove("expanded")},this.closeAllDropDowns=function(){document.removeEventListener("click",s),[].forEach.call(document.querySelectorAll(".js-slide-down-dropdown"),function(t){t.classList.remove("animated"),t.classList.remove("d-flex"),t.classList.add("d-none");var e=document.querySelector('[data-target="'+t.id+'"]');e.classList.remove("active"),e.classList.remove("expanded")})},this.closeCalendarDropDowns=function(){document.removeEventListener("click",s),[].forEach.call(document.querySelectorAll(".dropdown-calendar-mb"),function(t){t.classList.remove("animated"),t.classList.remove("d-flex"),t.classList.add("d-none");var e=document.querySelector('[data-target="'+t.id+'"]');e.classList.remove("active"),e.classList.remove("expanded")})},this.triggerSlideDown=function(t){t.preventDefault(),t.stopPropagation();var e=document.querySelector("#"+t.currentTarget.getAttribute("data-target")),i=e.classList.contains("d-flex"),s=e.classList.contains("dropdown-calendar-mb");i?this.closeDropDown(e):i&&s?(this.closeDropDown(e),this.closeCalendarDropDowns()):(this.closeCalendarDropDowns(),this.closeAllDropDowns(),this.openDropDown(e))},this.setGridGradientHeight=function(){if("none"!==window.getComputedStyle(this.els.activitiesGridGradient).display){var t=this.els.activitiesGrid.scrollHeight-(this.els.activitiesGrid.offsetHeight+this.els.activitiesGrid.scrollTop);this.els.activitiesGridGradient.style.height=(t<250?t:250)+"px"}},this.toggleMobileFilters=function(t){if(this.els.mobileFiltersOverlay.classList.toggle("d-none"),this.els.mobileFiltersBtn.classList.toggle("active"),this.els.filtersWrapper.classList.toggle("mobile-active"),this.els.filtersWrapper.classList.contains("mobile-active"))this.node.querySelector(".activities-top-bar-mobile").appendChild(this.els.filtersWrapper);else{var e=this.node.querySelector(".activities-top-bar-mobile").closest(".row");e.insertBefore(this.els.filtersWrapper,e.childNodes[1])}},this.abortRequest=function(){var t=this.getActiveDeck();null!=this.request&&(this.request.abort(),this.request=null),this.removeLoader(t),console.log("abort")},this.publishCalendar=function(t){var e=t.getAttribute("data-export-type"),i=t.closest(".card"),s=i.getAttribute("data-resort-code"),a=i.getAttribute("data-occurence-id");switch(e){case"ics":var n="/activity-ics/?code="+s+"&id="+a,o=document.createElement("a");o.href=n,o.download="activity.ics",o.target="_blank",document.body.appendChild(o),o.click(),document.body.removeChild(o)}},this.addEventListeners=function(){var s=this;[].forEach.call(this.els.layoutOptionsBtns,function(t){t.addEventListener("click",s.switchLayout.bind(s))}),[].forEach.call(this.els.activityModeToggler,function(t){t.addEventListener("click",s.switchMode.bind(s))}),[].forEach.call(this.els.filters,function(t){t.addEventListener("change",s.switchFilterState.bind(s)),t.parentElement.addEventListener("click",s.switchFilterState(t))}),[].forEach.call(this.els.sortingOptionsMobile,function(t){t.addEventListener("click",s.switchSorting.bind(s))}),[].forEach.call(this.els.datePickerTriggers,function(t){t.addEventListener("click",s.triggerDatepicker.bind(s))}),[].forEach.call(this.els.slideDownTogglers,function(t){t.addEventListener("click",s.triggerSlideDown.bind(s))}),[].forEach.call(this.els.activityModeToggler,function(t){t.addEventListener("click",s.closeCalendarDropDowns.bind(s))}),document.addEventListener("click",function(t){if(t.target){if(t.target.closest(".js-add-to-favorites")){t.preventDefault();var e=t.target.closest(".js-add-to-favorites");e.classList.toggle("active");var i=e.closest(".card");e.classList.contains("active")?(activityFavorites.add(i.getAttribute("data-occurence-id")),i.setAttribute("data-fav",1)):(activityFavorites.remove(i.getAttribute("data-occurence-id")),i.setAttribute("data-fav",0))}else t.target.closest("#ddCalWrapper")&&t.target.getAttribute("data-export-type")&&(t.preventDefault(),s.publishCalendar(t.target));t.target.closest(".js-read-more")&&(t.preventDefault(),s.toggleTextCollapse(t))}}),$("#sort-by").on("selectmenuchange",function(t){s.switchSorting(t)}),this.node.addEventListener("changeSearchParams",s.getData.bind(s)),this.node.addEventListener("changeLayout",s.ellipsizeTextBox),this.node.addEventListener("changeLayout",s.initReadMoreBtns),this.els.activitiesGrid.addEventListener("scroll",s.setGridGradientHeight.bind(s)),this.els.mobileFiltersOverlay.addEventListener("click",s.toggleMobileFilters.bind(s)),this.els.mobileFiltersOverlay.addEventListener("touchstart",s.toggleMobileFilters.bind(s)),this.els.mobileFiltersBtn.addEventListener("click",s.toggleMobileFilters.bind(s)),this.els.mobileClosedFiltersBtn.addEventListener("click",s.toggleMobileFilters.bind(s)),window.addEventListener("resize",s.ellipsizeTextBox),window.addEventListener("resize",s.initReadMoreBtns),this.horizontalCalendar.node.addEventListener("scrollCalendar",function(t){s.setNewDate(t.detail)}),this.horizontalCalendar.node.addEventListener("scrollingStart",this.abortRequest.bind(s))},this.init(e)}function HorizontalCalendar(t){var a,e=new CustomEvent("scrollingStart");this.init=function(){this.node=t,this.datesNodes=null,this.params={isIOS:/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,selectedDate:null,dateWidth:80,dateThreshold:1e-6,scrollingTimeout:null,isAnimating:null,touchEvent:null,isScrolling:null},this.windowParams={},this.updateWindowParams(),this.getDates(),this.generateDateBlocks(),this.addEventListeners()},this.updateWindowParams=function(){if(this.windowParams={},this.windowParams.windowCenter=window.innerWidth/2,this.windowParams.docViewLeft=this.windowParams.windowCenter-(this.params.dateWidth-this.params.dateThreshold),this.windowParams.docViewRight=this.windowParams.windowCenter+this.params.dateWidth,this.datesWrapper){var t=window.innerWidth-this.params.dateWidth;this.datesWrapper.style.padding="0px "+t/2+"px",this.datesWrapper.style.width=this.params.dates.length*this.params.dateWidth+t+"px"}},this.getSelectedData=function(){return this.params.selectedDate},this.getDates=function(){this.params.dates=[];for(var t=moment().startOf("day"),e=moment(moment().add("year",1)).startOf("day");t.add(1,"days").diff(e)<0;)this.params.dates.push(t.clone())},this.generateDateBlocks=function(){var i="";this.params.dates.forEach(function(t,e){i+='<span class="btn btn-action" data-date="'+t.format("MM/DD/YYYY")+'"><span class="month">'+t.format("MMM")+'</span><span class="day-of-week">'+t.format("DD")+", "+t.format("ddd")+"</span></span>"});var t=document.createElement("div"),e=window.innerWidth-this.params.dateWidth;t.classList.add("dates-wrapper"),t.style.width=this.params.dates.length*this.params.dateWidth+e+"px",t.style.padding="0px "+e/2+"px",t.innerHTML=i,this.node.appendChild(t),this.datesWrapper=t,this.datesNodes=t.childNodes},this.isScrolledIntoCenter=function(t){var e=t.getBoundingClientRect().left;return e+t.offsetWidth<=this.windowParams.docViewRight&&e>=this.windowParams.docViewLeft},this.handleScroll=function(t){if(this.params.isScrolling=!0,!this.params.isAnimating){var e=this;this.params.isIOS&&this.setActiveClass(),clearTimeout(this.params.scrollingTimeout),this.params.touchEvent?setTimeout(function(){console.log("scrollend, touchEvent = "+e.params.touchEvent),e.params.isScrolling=!1},0):this.params.scrollingTimeout=setTimeout(function(){console.log("scrollend, touchEvent = "+e.params.touchEvent),e.params.isAnimating=!0,e.params.isScrolling=!1,e.setActiveDate("scrollCalendar")},66)}},this.handleTouchStart=function(){this.params.touchEvent=!0,this.node.dispatchEvent(e)},this.handleClick=function(t){if($targetElement=$(t.target).parent(".btn"),$targetElement.length){var e=$targetElement.index()*this.params.dateWidth;$(this.node).animate({scrollLeft:e})}},this.handleTouchEnd=function(){console.log("touchend, isScrolling: "+this.params.isScrolling),this.params.touchEvent=!1,this.params.isScrolling||this.setActiveDate("touchCalendar")},this.setActiveClass=function(){var i=this;[].forEach.call(this.datesNodes,function(t){var e=t.classList.contains("active");i.isScrolledIntoCenter(t)?e||t.classList.add("active"):e&&t.classList.remove("active")})},this.setActiveDate=function(t){this.params.isIOS||this.setActiveClass();var e=this;this.params.isAnimating=!0;var i=$(e.node).find(".active").first(),s=i.index()*e.params.dateWidth;$(this.node).animate({scrollLeft:s},30,function(){e.params.selectedDate!==i.data("date")&&(e.params.selectedDate=i.data("date"),console.log("make search from "+t,"date: "+e.params.selectedDate),a=new CustomEvent(t,{detail:e.getSelectedData()}),e.node.dispatchEvent(a)),e.params.isAnimating=!1})},this.addEventListeners=function(){this.node.addEventListener("scroll",this.handleScroll.bind(this)),this.node.addEventListener("touchstart",this.handleTouchStart.bind(this)),this.node.addEventListener("touchend",this.handleTouchEnd.bind(this)),this.node.addEventListener("click",this.handleClick.bind(this)),window.addEventListener("resize",this.updateWindowParams.bind(this)),window.addEventListener("orientationchange",this.updateWindowParams.bind(this))},this.init()}function debounce(s,a,n){var o;return function(){var t=this,e=arguments,i=n&&!o;clearTimeout(o),o=setTimeout(function(){o=null,n||s.apply(t,e)},a),i&&s.apply(t,e)}}function throttle(e,i){var s,a,n=!1;return function t(){if(n)return s=arguments,void(a=this);e.apply(this,arguments),n=!0,setTimeout(function(){n=!1,s&&(t.apply(a,s),s=a=null)},i)}}!function(){function t(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};var i=document.createEvent("CustomEvent");return i.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),i}"function"!=typeof window.CustomEvent&&(t.prototype=window.Event.prototype,window.CustomEvent=t)}(),window.Element&&!Element.prototype.closest&&(Element.prototype.closest=function(t){var e,i=(this.document||this.ownerDocument).querySelectorAll(t),s=this;do{for(e=i.length;0<=--e&&i.item(e)!==s;);}while(e<0&&(s=s.parentElement));return s}),function(){if(Element){var t=Element.prototype;t.closest||(Element.prototype.closest=function(t){for(var e=this;e;){if(e.matches(t))return e;e=e.parentElement}return null}),t.matches||(t.matches=t.matchesSelector||t.mozMatchesSelector||t.msMatchesSelector||t.oMatchesSelector||t.webkitMatchesSelector)}}();